<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>WhatsApp Link Generator</title>
<!-- Removed link to external styles.css, using internal styles -->
<style>
    body {
        font-family: 'Arial', sans-serif;
        direction: rtl; /* Right-to-left layout */
        margin: 0;
        padding: 20px;
        background-color: #f4f4f4;
        display: flex;
        justify-content: center;
    }
    #container {
        background-color: #fff;
        padding: 20px 30px;
        border-radius: 8px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        max-width: 800px;
        width: 100%;
    }
    h1, h2 {
        text-align: center;
        color: #333;
    }
    textarea {
        width: 98%;
        min-height: 100px;
        margin-bottom: 10px;
        padding: 10px;
        border: 1px solid #ccc;
        border-radius: 4px;
        font-size: 14px;
        resize: vertical;
        font-family: inherit;
    }
    button { /* Style for main action buttons */
        padding: 10px 18px;
        background-color: #25D366; /* WhatsApp green */
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 16px;
        transition: background-color 0.3s ease;
        display: block;
        margin: 10px auto;
    }
    button:hover {
        background-color: #1DA851;
    }
    #output {
        margin-top: 20px;
        border-top: 1px solid #eee;
        padding-top: 20px;
    }
    /* Styling for each generated message block */
    .whatsapp-message {
        border: 1px solid #e0e0e0;
        background-color: #f9f9f9;
        padding: 15px;
        margin-bottom: 25px;
        border-radius: 5px;
        position: relative;
    }
    .whatsapp-message div {
        margin-bottom: 6px;
        line-height: 1.5;
    }
    .whatsapp-message hr {
       display: none;
    }
    .whatsapp-message a {
        color: #0056b3;
        text-decoration: none;
    }
     .whatsapp-message a:hover {
        text-decoration: underline;
    }
    .whatsapp-link-top {
        font-weight: bold;
        margin-bottom: 15px !important;
        display: block;
        font-size: 1.1em;
    }

    /* Common styles for small copy buttons */
    .copy-btn {
        padding: 6px 12px;
        font-size: 13px;
        background-color: #6c757d; /* Grey */
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        transition: background-color 0.2s ease;
        display: inline-block;
        margin: 0;
        white-space: nowrap; /* Prevent button text itself from wrapping */
    }
    .copy-btn:hover {
        background-color: #5a6268;
    }
    .copy-btn.copied {
        background-color: #28a745; /* Success green */
        color: white;
    }

    /* Container for the main "Copy Message" button */
    .copy-message-container {
        margin-top: 15px;
        text-align: left; /* Align button itself to the left */
    }

    /* Container for the form link and its copy button */
    .form-link-container {
        margin-top: 15px;
        padding: 10px;
        background-color: #ececec;
        border-radius: 4px;
        display: flex;
        /* Align button to the top line of text, better if link wraps */
        align-items: flex-start;
        width: 100%;
        box-sizing: border-box;
    }
    /* Span holding the descriptive text and the link */
    .form-link-text {
        flex-grow: 1; /* Allow this part to take up available space */
        margin-right: 10px; /* Space between text/link and button */
        min-width: 0; /* Crucial for allowing wrapping within flex items */
        line-height: 1.4; /* Readability for potentially wrapped text */
    }
    /* Styling the actual link inside the span */
    .form-link-text a {
        /* --- Key styles for wrapping --- */
        overflow-wrap: break-word; /* Standard property */
        word-wrap: break-word;     /* Older fallback */
        word-break: break-all;     /* Force break anywhere if needed */
        display: inline-block;     /* Treat link like a block for layout */
        max-width: 100%;           /* Don't exceed parent width */
        /* --- End wrapping styles --- */
        color: #0056b3;            /* Link color */
        text-decoration: none;
        vertical-align: middle;    /* Align with surrounding text nicely */
    }
    .form-link-text a:hover {
        text-decoration: underline;
    }
    /* Copy button specific styling within the form link container */
    .copy-link-btn {
       flex-shrink: 0; /* Prevent button from shrinking */
    }

    #vcf-instructions {
        text-align: center;
        margin-top: 20px;
        font-size: 14px;
        color: #555;
        line-height: 1.6;
    }
    #vcf-instructions a {
        color: #0056b3;
    }

    /* Optional: Add style for the summary message */
    #output-summary {
        text-align: center;
        font-weight: bold;
        margin-bottom: 15px;
        font-size: 1.1em;
        color: #333;
    }

</style>
</head>
<body>
 <div id="container">
   <h1>WhatsApp Link Generator</h1>

   <h2> הדביקי טבלה:</h2>
   <textarea id="paste-area" placeholder="הדביקי טבלה מקובץ Excel כאן...
העמודות הנדרשות: מספר משתתף, שם פרטי, שם משפחה, מספר טלפון"></textarea>
   <button id="paste-button">צרי קישורים</button>

  <div id="output"></div>

  <button id="export-vcf-button">ייצאי קובץ אנשי קשר (VCF)</button>
  <p id="vcf-instructions">
    לאחר הורדת קובץ ה-VCF, פתחי את <a href="https://contacts.google.com/" target="_blank">Google Contacts</a>.<br>
    חפשי אפשרות בשם <strong>"יבאי"</strong> או <strong>"Import"</strong>. <br>
    לרוב, אפשרות זו נמצאת בתפריט הצדדי, או תחת הגדרות (סמל גלגל השיניים).
  </p>
 </div>

 <script>
  const outputContainer = document.getElementById('output');
  const pasteArea = document.getElementById('paste-area');
  const pasteButton = document.getElementById('paste-button');
  const exportVCFButton = document.getElementById('export-vcf-button');

  pasteButton.addEventListener('click', () => {
     const pastedData = pasteArea.value;
     if (pastedData.trim() !== '') {
       generateWhatsappLinks(pastedData);
     } else {
       alert('אנא הדביקי טבלה.');
     }
   });

  function sanitizeColumnName(header) {
    return header.trim().toLowerCase().replace(/[^a-zא-ת0-9]/g, '');
  }

  function sanitizeHebrewText(text) {
    if (!text) return '';
    return text.trim().replace(/[^\u0590-\u05FFa-zA-Z0-9\s.,!?'":;()/-]/g, '').trim();
  }

  let contactsData = []; // To store data for VCF export

  function generateWhatsappLinks(csvData) {
    if (csvData.includes('\t')) {
      csvData = csvData.replace(/\t/g, ',');
    }
    outputContainer.innerHTML = '';
    contactsData = [];

    const normalizedCSVData = csvData.replace(/^\uFEFF/, '').replace(/\r\n/g, '\n').replace(/\r/g, '\n');
    const rows = normalizedCSVData.split('\n');

    if (rows.length <= 1 && rows[0].trim() === '') {
        alert('הנתונים שהודבקו ריקים או לא תקינים.');
        return;
    }

    const headers = rows[0].split(',').map(header => sanitizeColumnName(header));

    const columnPatterns = {
       pnid: ['pnid', 'participantid', 'מספרמשתתף', 'participant', 'number', 'sk'], // Added 'sk'
       firstName: ['firstname', 'first', 'פרטי'],
       lastName: ['lastname', 'last', 'משפחה'],
       phone: ['phone', 'phonenumber', 'מספרטלפון', 'טלפון', 'נייד', 'mobile'] // Added mobile
     };

    const findColumnIndex = (patterns) => {
      return headers.findIndex(header =>
        patterns.some(pattern => header.includes(pattern))
      );
    };

    const pnidIndex = findColumnIndex(columnPatterns.pnid);
    const firstNameIndex = findColumnIndex(columnPatterns.firstName);
    const lastNameIndex = findColumnIndex(columnPatterns.lastName);
    const phoneIndex = findColumnIndex(columnPatterns.phone);

    if (pnidIndex === -1 || firstNameIndex === -1 ||
        lastNameIndex === -1 || phoneIndex === -1) {
       const missing = [];
       if (pnidIndex === -1) missing.push("מספר משתתף (כותרת לדוגמה: 'pnid', 'מספר משתתף', 'sk')");
       if (firstNameIndex === -1) missing.push("שם פרטי (כותרת לדוגמה: 'firstname', 'פרטי')");
       if (lastNameIndex === -1) missing.push("שם משפחה (כותרת לדוגמה: 'lastname', 'משפחה')");
       if (phoneIndex === -1) missing.push("מספר טלפון (כותרת לדוגמה: 'phone', 'טלפון', 'נייד')");
      alert(`לא נמצאו כל העמודות הנדרשות. אנא ודאי שהטבלה מכילה עמודות עם כותרות מתאימות עבור:\n- ${missing.join('\n- ')}\n\nהכותרות שנמצאו בשורה הראשונה: ${headers.join(', ')}`);
      return;
    }

    let generatedCount = 0; // Count generated messages

    for (let i = 1; i < rows.length; i++) {
      const rowString = rows[i].trim();
      if (!rowString) continue;

      const row = parseCsvRow(rowString); // Use helper function for parsing

      if (row.length <= Math.max(pnidIndex, firstNameIndex, lastNameIndex, phoneIndex)) {
        console.warn(`Skipping row ${i + 1}: Not enough columns. Row content: "${rowString}"`);
        continue;
      }

      const pnid = (row[pnidIndex] || '').trim();
      const firstName = sanitizeHebrewText(row[firstNameIndex] || '');
      const lastName = sanitizeHebrewText(row[lastNameIndex] || '');
      let phone = (row[phoneIndex] || '').trim();

      if (phone && firstName) {
        phone = phone.replace(/[^0-9]/g, '');
        if (phone.startsWith('972') && phone.length > 9) { // Handle cases where 972 is already present
             phone = phone.substring(3); // Remove existing 972 if user pasted it
        }
        if (phone.startsWith('0')) {
          phone = phone.substring(1);
        }

        if (phone.length >= 9 && phone.length <= 10) { // Validate Israeli number length (9 or 10 digits after 0)
            const fullPhone = `972${phone}`;
            const displayPhone = `0${phone}`; // For display purposes

            contactsData.push({
              firstName: firstName,
              lastName: lastName,
              phone: fullPhone,
              pnid: pnid
            });

            // Create message container div
            const messageDiv = document.createElement('div');
            messageDiv.className = 'whatsapp-message';

            // 1. WhatsApp Link (Top)
            const whatsappLinkTop = document.createElement('a');
            whatsappLinkTop.href = `https://wa.me/${fullPhone}`;
            whatsappLinkTop.target = '_blank';
            whatsappLinkTop.textContent = `פתח צ'אט עם ${firstName} ${lastName} (${displayPhone})`;
            whatsappLinkTop.className = 'whatsapp-link-top'; // Apply specific class
            messageDiv.appendChild(whatsappLinkTop);

            // 2. Message Body
            const messageLines = [
              `${firstName} ${lastName} יקר/ה,`,
              'תודה שנרשמת למחקר מיקרוביום!',
              'כחלק מהמחקר אנו מבקשים למלא שאלונים שמטרתם לבדוק את הקשר בין אוכלוסיית החיידקים האישית שלך למצבים הקשורים לבריאות וחולי.',
              'מצורפים קישורים לשני שאלונים:',
              '1. שאלון כללי (קל ונגיש למילוי דרך הטלפון)',
              '2. שאלון תזונתי (מומלץ למילוי דרך מחשב)',
              '• את השאלונים ניתן למלא באופן דיגיטלי או באופן ידני עם הגעתך לסקר.',
              '• תוצאות המחקר יישלחו אליך באמצעות השיבא קונקט, תקבל על כך הודעה במייל ואסאמאס.',
              '',
              'במידה והקישורים לא נפתחים יש לשמור מספר זה באנשי הקשר',
              'תודה,',
              'צוות המחקר',
              '------',
              `*שים לב - מספר המשתתף שלך במחקר הוא ${pnid}* `,
              '*על שינוי/דחיית תאריך נבקש ליידע אותנו כאן בצ\'אט, תודה על שיתוף הפעולה*'
            ];

            const fullMessageText = messageLines.join('\n'); // For the copy button

            messageLines.forEach(line => {
              const lineElement = document.createElement('div');
               if (line.startsWith('http://') || line.startsWith('https://')) {
                 const linkEl = document.createElement('a');
                 linkEl.href = line;
                 linkEl.target = '_blank';
                 linkEl.textContent = line;
                 lineElement.appendChild(linkEl);
               } else {
                  lineElement.textContent = line || '\u00A0'; // Add non-breaking space for empty lines
               }
              messageDiv.appendChild(lineElement);
            });

             // 3. Container for the "Copy Message" button
             const copyMessageContainer = document.createElement('div');
             copyMessageContainer.className = 'copy-message-container';
             const copyMsgButton = createCopyButton(fullMessageText, 'העתיקי הודעה', 'copy-message-btn');
             copyMessageContainer.appendChild(copyMsgButton);
             messageDiv.appendChild(copyMessageContainer); // Add below message text


            // 4. Google Form Link Section
            const googleFormLinkUrl = 'https://docs.google.com/forms/d/e/1FAIpQLSfmzRlxyheTn6xndmsxx4AM3QHGKldZtb3w_QVDMHaPnECMSA/viewform';
            const formLinkContainer = document.createElement('div');
            formLinkContainer.className = 'form-link-container'; // Apply class for styling

            // Create text and link span
            const formLinkTextSpan = document.createElement('span');
            formLinkTextSpan.className = 'form-link-text';
            formLinkTextSpan.appendChild(document.createTextNode('קישור לשאלון כללי: '));
            const googleFormLinkElement = document.createElement('a');
            googleFormLinkElement.href = googleFormLinkUrl;
            googleFormLinkElement.target = '_blank';
            googleFormLinkElement.textContent = googleFormLinkUrl; // Show full URL or shorter text if preferred
            formLinkTextSpan.appendChild(googleFormLinkElement);

            // Create copy button
            const copyLinkFormButton = createCopyButton(googleFormLinkUrl, 'העתיקי קישור', 'copy-link-btn');

            // Append elements to container (order matters for flexbox justification)
            formLinkContainer.appendChild(formLinkTextSpan); // Text + Link on the left
            formLinkContainer.appendChild(copyLinkFormButton); // Button on the right

            messageDiv.appendChild(formLinkContainer); // Add below copy message button

            // --- (Separator is now handled by .whatsapp-message margin) ---

            outputContainer.appendChild(messageDiv);
            generatedCount++; // Increment count
         } else {
             console.warn(`Skipping row ${i+1}: Invalid or incomplete phone number "${row[phoneIndex]}" for ${firstName} ${lastName}. Expected 9 or 10 digits after leading 0.`);
         }
      } else {
          if (!rowString.match(/^,*$/)) {
             console.warn(`Skipping row ${i+1}: Missing phone number or first name. Row content: "${rowString}"`);
          }
      }
    }

     if (generatedCount === 0) {
       outputContainer.innerHTML = '<p style="text-align:center; color: red;">לא נוצרו קישורים. אנא בדקי את הנתונים שהודבקו ואת כותרות העמודות (השורה הראשונה). ודאי שיש נתונים תקינים של שם פרטי ומספר טלפון.</p>';
     } else {
         // Optional: Add a summary message
         const summary = document.createElement('p');
         summary.textContent = `נוצרו ${generatedCount} הודעות.`;
         summary.style.textAlign = 'center';
         summary.style.fontWeight = 'bold';
         outputContainer.insertBefore(summary, outputContainer.firstChild);
     }
  }

  // Helper function for robust CSV row parsing
  function parseCsvRow(rowString) {
      const row = [];
      let currentField = '';
      let inQuotes = false;
      for (let j = 0; j < rowString.length; j++) {
          const char = rowString[j];
          const nextChar = rowString[j+1];

          if (char === '"') {
              if (inQuotes && nextChar === '"') {
                  // Handle escaped double quote ("") inside quoted field
                  currentField += '"';
                  j++; // Skip the next quote
              } else {
                  inQuotes = !inQuotes;
                  // Optionally ignore the quote character itself unless escaped
              }
          } else if (char === ',' && !inQuotes) {
              row.push(currentField.trim());
              currentField = '';
          } else {
              currentField += char;
          }
      }
      row.push(currentField.trim()); // Add the last field
      return row;
  }


  // Modified createCopyButton to accept an additional specific class
  function createCopyButton(textToCopy, buttonText = 'העתיקי', specificClass = '') {
    const copyButton = document.createElement('button');
    copyButton.textContent = buttonText;
    // Apply base class and specific class
    copyButton.className = `copy-btn ${specificClass}`.trim();

    copyButton.addEventListener('click', (e) => {
      e.stopPropagation();
      navigator.clipboard.writeText(textToCopy).then(() => {
        const originalText = copyButton.textContent;
        copyButton.textContent = 'הועתק!';
        copyButton.classList.add('copied');
        // Disable button briefly to prevent rapid clicks
        copyButton.disabled = true;
        setTimeout(() => {
          copyButton.textContent = originalText;
          copyButton.classList.remove('copied');
          copyButton.disabled = false;
        }, 1500); // Shorter timeout
      }).catch(err => {
        console.error('Failed to copy: ', err);
        alert('העתקה נכשלה. בדקי הרשאות דפדפן.');
      });
    });
    return copyButton;
  }

  function exportVCF() {
    if (contactsData.length === 0) {
      alert('לא נוצרו אנשי קשר לייצוא. יש ליצור קישורים תחילה.');
      return;
    }

    let vcfContent = '';
    contactsData.forEach(contact => {
      const fullName = `${contact.firstName} ${contact.lastName}`;
      vcfContent += `BEGIN:VCARD\n`;
      vcfContent += `VERSION:3.0\n`;
      vcfContent += `FN;CHARSET=UTF-8:${fullName}\n`;
      vcfContent += `N;CHARSET=UTF-8:${contact.lastName};${contact.firstName};;;\n`;
      vcfContent += `TEL;TYPE=CELL:+${contact.phone}\n`;
      vcfContent += `NOTE;CHARSET=UTF-8:מספר משתתף: ${contact.pnid}\n`; // Correct UTF-8 Note
      vcfContent += `END:VCARD\n`;
    });

    const blob = new Blob(['\uFEFF' + vcfContent], { type: 'text/vcard;charset=utf-8' }); // Add BOM
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = 'contacts.vcf';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(url);
  }

  exportVCFButton.addEventListener('click', exportVCF);

</script>
</body>
</html>
