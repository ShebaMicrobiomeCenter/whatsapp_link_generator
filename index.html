<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>WhatsApp Link Generator</title>
<link rel="stylesheet" href="styles.css">
<style>
    /* Optional: Add some basic styling for the new button if needed */
    .copy-link-button {
        margin-left: 5px; /* Add space between link and button */
        /* Add other styles similar to copy-button if desired */
    }
    .whatsapp-message div { /* Add some spacing between message lines */
        margin-bottom: 5px;
    }
    .whatsapp-message hr {
      margin-top: 15px;
      margin-bottom: 15px;
    }
    /* Style for the copied state */
    .copy-button.copied, .copy-link-button.copied {
        background-color: #4CAF50; /* Green background */
        color: white;
    }
</style>
</head>
<body>
 <div id="container">
   <h1>WhatsApp Link Generator</h1>

   <h2> הדביקי טבלה:</h2>
   <textarea id="paste-area" placeholder="הדביקי טבלה מקובץ Excel כאן..."></textarea>
   <button id="paste-button">צרי קישורים</button>

  <div id="output"></div>

  <button id="export-vcf-button">ייצאי קובץ אנשי קשר (VCF)</button>
  <p id="vcf-instructions" style="text-align: center;">
    לאחר הורדת קובץ ה-VCF, פתחי את <a href="https://contacts.google.com/" target="_blank">Google Contacts</a>.<br>
    חפשי אפשרות בשם <strong>"יבאי"</strong> או <strong>"Import"</strong>. <br>
    לרוב, אפשרות זו נמצאת בתפריט הצדדי, או תחת הגדרות (סמל גלגל השיניים).
  </p>
 </div>

 <script>
  // Removed redundant elements no longer in HTML (dropArea, fileInput, browseButton)
  const outputContainer = document.getElementById('output');
  const pasteArea = document.getElementById('paste-area');
  const pasteButton = document.getElementById('paste-button');
  const exportVCFButton = document.getElementById('export-vcf-button');
  // Removed googleContactsLink as it's directly in HTML now

   pasteButton.addEventListener('click', () => {
     const pastedData = pasteArea.value;
     if (pastedData.trim() !== '') {
       generateWhatsappLinks(pastedData);
     } else {
       alert('אנא הדביקי טבלה.');
     }
   });

  function sanitizeColumnName(header) {
    // Remove whitespace, convert to lowercase, remove non-alphanumeric characters
    return header.trim().toLowerCase().replace(/[^a-zא-ת0-9]/g, '');
  }

  // Removed handleFileList function as file input is removed

  function sanitizeHebrewText(text) {
    if (!text) return '';
    // Keep Hebrew, English letters, numbers, spaces, and basic punctuation
    return text.trim().replace(/[^\u0590-\u05FFa-zA-Z0-9\s.,!?'":;()/-]/g, '').trim();
  }

  let contactsData = []; // To store data for VCF export

  function generateWhatsappLinks(csvData) {
    // Clear previous output
    // Handle tab-separated data pasted from Excel/Sheets
    if (csvData.includes('\t')) {
      csvData = csvData.replace(/\t/g, ',');
    }
    outputContainer.innerHTML = '';
    contactsData = []; // Clear previous data

    // Remove any potential Byte Order Mark and normalize line endings
    const normalizedCSVData = csvData.replace(/^\uFEFF/, '').replace(/\r\n/g, '\n').replace(/\r/g, '\n');
    const rows = normalizedCSVData.split('\n');

    // Parse headers (first row)
    const headers = rows[0].split(',').map(header => sanitizeColumnName(header));

    // Define column name patterns
    const columnPatterns = {
       pnid: ['pnid', 'participantid', 'מספרמשתתף', 'participant', 'number'],
       firstName: ['firstname', 'first', 'פרטי'],
       lastName: ['lastname', 'last', 'משפחה'],
       phone: ['phone', 'phonenumber', 'מספרטלפון', 'טלפון']
     };

    // Find column indices with more flexible matching
    const findColumnIndex = (patterns) => {
      return headers.findIndex(header =>
        patterns.some(pattern => header.includes(pattern))
      );
    };

    const pnidIndex = findColumnIndex(columnPatterns.pnid);
    const firstNameIndex = findColumnIndex(columnPatterns.firstName);
    const lastNameIndex = findColumnIndex(columnPatterns.lastName);
    const phoneIndex = findColumnIndex(columnPatterns.phone);

    // Validate column indices
    if (pnidIndex === -1 || firstNameIndex === -1 ||
        lastNameIndex === -1 || phoneIndex === -1) {
       const missing = [];
       if (pnidIndex === -1) missing.push("מספר משתתף (e.g., 'pnid', 'participantid')");
       if (firstNameIndex === -1) missing.push("שם פרטי (e.g., 'firstname', 'פרטי')");
       if (lastNameIndex === -1) missing.push("שם משפחה (e.g., 'lastname', 'משפחה')");
       if (phoneIndex === -1) missing.push("מספר טלפון (e.g., 'phone', 'טלפון')");
      alert(`לא נמצאו כל העמודות הנדרשות. אנא ודאי שהטבלה מכילה עמודות עם כותרות מתאימות עבור:\n- ${missing.join('\n- ')}\n\nהכותרות שנמצאו: ${headers.join(', ')}`);
      return;
    }

    // Process each row
    for (let i = 1; i < rows.length; i++) {
      const rowString = rows[i].trim();
      if (!rowString) continue;

      // Robust CSV parsing considering quoted fields
      const row = [];
      let currentField = '';
      let inQuotes = false;
      for (let j = 0; j < rowString.length; j++) {
        const char = rowString[j];
        if (char === '"' && (j === 0 || rowString[j-1] !== '\\')) { // Handle escaped quotes if needed later (\")
            // Check if the quote is doubled "" inside quotes, treat as literal quote
            if (inQuotes && rowString[j+1] === '"') {
                currentField += '"';
                j++; // Skip the next quote
            } else {
                inQuotes = !inQuotes;
            }
        } else if (char === ',' && !inQuotes) {
          row.push(currentField.trim());
          currentField = '';
        } else {
          currentField += char;
        }
      }
      row.push(currentField.trim()); // Add the last field


      // Validate row has enough columns based on max index needed
      if (row.length <= Math.max(pnidIndex, firstNameIndex, lastNameIndex, phoneIndex)) {
        console.warn(`Skipping row ${i + 1}: Not enough columns. Row content: "${rowString}"`);
        continue;
      }

      const pnid = row[pnidIndex] || '';
      const firstName = sanitizeHebrewText(row[firstNameIndex] || '');
      const lastName = sanitizeHebrewText(row[lastNameIndex] || '');
      let phone = row[phoneIndex] || '';

      // Process phone number
      if (phone && phone.trim() !== "" && firstName) { // Added check for firstName to avoid empty entries
        phone = phone.replace(/[^0-9]/g, ''); // Keep only digits
        if (phone.startsWith('0')) {
          phone = phone.substring(1);
        }
        if (phone.length >= 9) { // Basic validation for Israeli number length
            phone = `972${phone}`;

            // Store data for VCF
            contactsData.push({
              firstName: firstName,
              lastName: lastName,
              phone: phone,
              pnid: pnid
            });

            // Create message div
            const messageDiv = document.createElement('div');
            messageDiv.className = 'whatsapp-message';

            // WhatsApp Link (Top)
            const whatsappLink = document.createElement('a');
            whatsappLink.href = `https://wa.me/${phone}`;
            whatsappLink.target = '_blank';
            whatsappLink.textContent = `פתח צ'אט עם ${firstName} ${lastName} (${phone.replace('972', '0')})`; // More descriptive link text
            whatsappLink.style.fontWeight = 'bold'; // Make it stand out


            // Full message content for copying
            const messageLines = [
              `${firstName} ${lastName} יקר/ה,`,
              'תודה שנרשמת למחקר מיקרוביום!',
              'כחלק מהמחקר אנו מבקשים למלא שאלונים שמטרתם לבדוק את הקשר בין אוכלוסיית החיידקים האישית שלך למצבים הקשורים לבריאות וחולי.',
              'מצורפים קישורים לשני שאלונים:',
              '1. שאלון כללי (קל ונגיש למילוי דרך הטלפון)',
              '2. שאלון תזונתי (מומלץ למילוי דרך מחשב)',
              '• את השאלונים ניתן למלא באופן דיגיטלי או באופן ידני עם הגעתך לסקר.',
              '• תוצאות המחקר יישלחו אליך באמצעות השיבא קונקט, תקבל על כך הודעה במייל ואסאמאס.',
              '',
              'במידה והקישורים לא נפתחים יש לשמור מספר זה באנשי הקשר',
              'תודה,',
              'צוות המחקר',
              '------',
              `*שים לב - מספר המשתתף שלך במחקר הוא ${pnid}* `,
              '*על שינוי/דחיית תאריך נבקש ליידע אותנו כאן בצ\'אט, תודה על שיתוף הפעולה*'
            ];

            // Create full message text for copying
            const fullMessageText = messageLines.join('\n');

             // Create container for buttons
            const buttonContainer = document.createElement('div');
            buttonContainer.style.marginTop = '10px'; // Add some space above buttons

            // Add Copy Message button
            const copyMsgButton = createCopyButton(fullMessageText, 'העתיקי הודעה');
            buttonContainer.appendChild(copyMsgButton);


            // Add WhatsApp link again (or just keep it at top)
            messageDiv.appendChild(whatsappLink);
            messageDiv.appendChild(document.createElement('br'));
            messageDiv.appendChild(document.createElement('br'));


            // Render message lines
            messageLines.forEach(line => {
              const lineElement = document.createElement('div');
               // Simple link detection (optional, adjust regex if needed)
               if (line.startsWith('http://') || line.startsWith('https://')) {
                 const linkEl = document.createElement('a');
                 linkEl.href = line;
                 linkEl.target = '_blank';
                 linkEl.textContent = line;
                 lineElement.appendChild(linkEl);
               } else {
                  lineElement.textContent = line;
               }
              messageDiv.appendChild(lineElement);
            });

            // --- START: Add Google Form Link and Copy Button ---
            const googleFormLinkUrl = 'https://docs.google.com/forms/d/e/1FAIpQLSfmzRlxyheTn6xndmsxx4AM3QHGKldZtb3w_QVDMHaPnECMSA/viewform';

            const googleFormLinkElement = document.createElement('a');
            googleFormLinkElement.href = googleFormLinkUrl;
            googleFormLinkElement.target = '_blank';
            googleFormLinkElement.textContent = googleFormLinkUrl;

            const copyLinkFormButton = document.createElement('button');
            copyLinkFormButton.textContent = 'העתיקי קישור לשאלון';
            copyLinkFormButton.className = 'copy-link-button'; // Add class for styling
            copyLinkFormButton.style.marginLeft = '5px'; // Space between link and button

            copyLinkFormButton.addEventListener('click', (e) => {
                e.stopPropagation(); // Prevent triggering other clicks if nested
                navigator.clipboard.writeText(googleFormLinkUrl).then(() => {
                    copyLinkFormButton.textContent = 'הועתק!';
                    copyLinkFormButton.classList.add('copied');
                    setTimeout(() => {
                        copyLinkFormButton.textContent = 'העתיקי קישור לשאלון';
                        copyLinkFormButton.classList.remove('copied');
                    }, 2000);
                }).catch(err => {
                    console.error('Failed to copy link: ', err);
                    alert('העתקת הקישור נכשלה');
                });
            });

            const formLinkContainer = document.createElement('div');
            formLinkContainer.style.marginTop = '10px'; // Add space above the form link
            formLinkContainer.appendChild(document.createTextNode('קישור לשאלון כללי: ')); // Add descriptive text
            formLinkContainer.appendChild(googleFormLinkElement);
            formLinkContainer.appendChild(copyLinkFormButton);

            messageDiv.appendChild(formLinkContainer); // Add the form link container

             // --- END: Add Google Form Link and Copy Button ---


            // Add the button container (with copy message button)
            messageDiv.appendChild(buttonContainer);


            // Add a horizontal line separator
            messageDiv.appendChild(document.createElement('hr'));

            outputContainer.appendChild(messageDiv);
         } else {
             console.warn(`Skipping row ${i+1}: Invalid or incomplete phone number "${row[phoneIndex]}" for ${firstName} ${lastName}`);
         }
      } else {
          // Optionally log skipped rows due to missing phone or name
          if (!rowString.match(/^,*$/)) { // Avoid logging empty rows
             console.warn(`Skipping row ${i+1}: Missing phone number or name. Row content: "${rowString}"`);
          }
      }
    }
     if (outputContainer.children.length === 0) {
       outputContainer.innerHTML = '<p style="text-align:center; color: red;">לא נמצאו נתונים תקינים לעיבוד. אנא בדקי את מבנה הטבלה והעמודות.</p>';
     }
  }

  // Modified createCopyButton to accept button text
  function createCopyButton(textToCopy, buttonText = 'העתיקי') {
    const copyButton = document.createElement('button');
    copyButton.textContent = buttonText;
    copyButton.className = 'copy-button'; // Use a general class

    copyButton.addEventListener('click', (e) => {
      e.stopPropagation(); // Prevent triggering other clicks if nested
      navigator.clipboard.writeText(textToCopy).then(() => {
        const originalText = copyButton.textContent;
        copyButton.textContent = 'הועתק!';
        copyButton.classList.add('copied');
        setTimeout(() => {
          copyButton.textContent = originalText;
          copyButton.classList.remove('copied');
        }, 2000);
      }).catch(err => {
        console.error('Failed to copy text: ', err);
        alert('העתקה נכשלה');
      });
    });

    return copyButton;
  }

  function exportVCF() {
    if (contactsData.length === 0) {
      alert('לא נוצרו אנשי קשר לייצוא. יש ליצור קישורים תחילה.');
      return;
    }

    let vcfContent = '';
    contactsData.forEach(contact => {
      // Ensure names are properly encoded for VCF if they contain non-ASCII
      const encodedFirstName = contact.firstName; // Simple assignment, potentially needs base64 for complex chars
      const encodedLastName = contact.lastName; // Simple assignment
      const fullName = `${encodedFirstName} ${encodedLastName}`;

      vcfContent += `BEGIN:VCARD\n`;
      vcfContent += `VERSION:3.0\n`;
      // FN property is usually required
      vcfContent += `FN;CHARSET=UTF-8:${fullName}\n`;
      // N property for structured name
      vcfContent += `N;CHARSET=UTF-8:${encodedLastName};${encodedFirstName};;;\n`; // Last;First;Middle;Prefix;Suffix
      vcfContent += `TEL;TYPE=CELL:+${contact.phone}\n`;
      // Add PNID to NOTE field, ensuring proper encoding
      vcfContent += `NOTE;CHARSET=UTF-8:מספר משתתף: ${contact.pnid}\n`;
      vcfContent += `END:VCARD\n`;
    });

    // Ensure UTF-8 BOM for better compatibility with various contact apps
    const blob = new Blob(['\uFEFF' + vcfContent], { type: 'text/vcard;charset=utf-8' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = 'contacts.vcf';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(url);
  }

  exportVCFButton.addEventListener('click', exportVCF);

</script>
</body>
</html>
